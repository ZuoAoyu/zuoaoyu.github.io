<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=theme-color content="dark"><title>迁移WordPress | 侠客</title>
<meta property="og:site_name" content="侠客"><meta property="og:title" content="迁移WordPress | 侠客"><meta itemprop=name content="迁移WordPress | 侠客"><meta name=twitter:title content="迁移WordPress | 侠客"><meta name=application-name content="迁移WordPress | 侠客"><meta name=twitter:card content="summary"><meta name=description content="工作、学习、生活、理想"><meta name=twitter:description content="工作、学习、生活、理想"><meta itemprop=description content="工作、学习、生活、理想"><meta property="og:description" content="工作、学习、生活、理想"><meta property="og:type" content="article"><meta property="article:publisher" content="Guanghao Zuo"><meta property="og:article:published_time" content="2019-08-31T15:53:43+0800"><meta property="article:published_time" content="2019-08-31T15:53:43+0800"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"迁移WordPress","author":{"@type":"Person","name":"Guanghao Zuo"},"datePublished":"2019-08-31","description":"","wordCount":886,"mainEntityOfPage":"True","dateModified":"2019-08-31","publisher":{"@type":"Organization","name":"Guanghao Zuo","logo":{"@type":"imageObject","url":"https:\/\/o5o.me\/favicon.ico"}}}</script><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css></head><script>(function(){const e="ThemeColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="ThemeColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.userColorScheme="dark":document.documentElement.dataset.userColorScheme="light"})()</script><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/><img src=/favicon.ico>
侠客</a></div><div class=flex><a href=/articles/>Articles</a>
<button id=dark-mode-button><svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163.0 101.643 1.641 1.163 1.163.0 00-1.643-1.641zm-16.022 14.38a1.74 1.74.0 000 2.465 1.742 1.742.0 100-2.465zm13.968-2.147a2.904 2.904.0 01-4.108.0 2.902 2.902.0 010-4.107 2.902 2.902.0 014.108.0 2.902 2.902.0 010 4.107z" fill="#ffcc4d"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg><svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)" viewBox="0 0 36 36"><path fill="#ffd983" d="M16 2s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2V2zm18 14s2 0 2 2-2 2-2 2h-2s-2 0-2-2 2-2 2-2h2zM4 16s2 0 2 2-2 2-2 2H2s-2 0-2-2 2-2 2-2h2zm5.121-8.707s1.414 1.414.0 2.828-2.828.0-2.828.0L4.878 8.708s-1.414-1.414.0-2.829c1.415-1.414 2.829.0 2.829.0l1.414 1.414zm21 21s1.414 1.414.0 2.828-2.828.0-2.828.0l-1.414-1.414s-1.414-1.414.0-2.828 2.828.0 2.828.0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828.0.0-2.828.0-2.828l1.414-1.414s1.414-1.414 2.828.0.0 2.828.0 2.828l-1.414 1.414zM16 32s0-2 2-2 2 2 2 2v2s0 2-2 2-2-2-2-2v-2z"/><circle fill="#ffd983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)"/></svg></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>迁移WordPress</h1><div class=post-meta><div>By Guanghao Zuo | <time>August 31, 2019</time>
| 5 minutes</div><div class=tags></div></div></div></div></header></article><div class=article-post><p>侠客是放在阿里云的轻量应用服务器上的，我直接用的LAMP镜像。这几天感觉博客访问越来越慢，并且WP的后台提示我该升级PHP版本了。侠客的PHP版本还是5.x，确实要升级一下。升级php不知道又会遇到什么问题，还是换台服务器比较好。
这台服务器是在阿里云的北京机房，系统是ubuntu18.04。
首先更新系统。</p><pre tabindex=0><code>apt-get update
apt-get upgrade
apt-get dist-upgrade
</code></pre><p>安装php</p><pre tabindex=0><code>apt-get install php
php -v（查看版本）
</code></pre><p>安装php自动把apache也安装了，很奇怪。
安装Mysql</p><pre tabindex=0><code>apt-get install mysql-server （中间会让输入root密码）
apt-get install mysql-client

#查看是否安装成功
mysql -u root -p
#回车，输入密码，也可能不需要输密码
select version();
exit; #退出mysql环境
</code></pre><p>打印phpinfo，查看php信息，如php.ini路径</p><pre tabindex=0><code>#新建php文件并写入下述语句，通过浏览器访问文件
php echo phpinfo(); ?
</code></pre><p>浏览器访问服务器ip，可看到apache默认页面内容，页面上会显示出网页文件的根目录、配置文件路径等内容。</p><pre tabindex=0><code># It works!
This is the default welcome page used to test the correct 
operation of the Apache2 server after installation on Ubuntu systems.
It is based on the equivalent page on Debian, from which the Ubuntu Apache
packaging is derived.
If you can read this page, it means that the Apache HTTP server installed at
this site is working properly. You should **replace this file** (located at
`/var/www/html/index.html`) before continuing to operate your HTTP server.

If you are a normal user of this web site and don&#39;t know what this page is
about, this probably means that the site is currently unavailable due to
maintenance.
If the problem persists, please contact the site&#39;s administrator.
# Configuration Overview

Ubuntu&#39;s Apache2 default configuration is different from the
upstream default configuration, and split into several files optimized for
interaction with Ubuntu tools. The configuration system is
**fully documented in
/usr/share/doc/apache2/README.Debian.gz**. Refer to this for the full
documentation. Documentation for the web server itself can be
found by accessing the **manual** if the **apache2-doc**
package was installed on this server.

The configuration layout for an Apache2 web server installation on Ubuntu systems is as follows:
</code></pre><p>/etc/apache2/
|&ndash; apache2.conf
| <code>-- ports.conf |-- mods-enabled | |-- *.load | </code>&ndash; *.conf
|&ndash; conf-enabled
| <code>-- *.conf |-- sites-enabled | </code>&ndash; *.conf</p><pre tabindex=0><code>*   **apache2.conf** is the main configuration file. It puts the pieces together by including all remaining configuration files when starting up the web server.
*   **ports.conf** is always included from the main configuration file. It is used to determine the listening ports for incoming connections, and this file can be customized anytime.
*   Configuration files in the **mods-enabled/**, **conf-enabled/** and **sites-enabled/** directories contain particular configuration snippets which manage modules, global configuration fragments, or virtual host configurations, respectively.
*   They are activated by symlinking available configuration files from their respective \*-available/ counterparts. These should be managed by using our helpers **a2enmod, a2dismod,** **a2ensite, a2dissite,** and **a2enconf, a2disconf** . See their respective man pages for detailed information.
*   The binary is called apache2. Due to the use of environment variables, in the default configuration, apache2 needs to be started/stopped with **/etc/init.d/apache2** or **apache2ctl**. Calling **/usr/bin/apache2** directly will not work with the default configuration.

# Document Roots

By default, Ubuntu does not allow access through the web browser to _any_ file apart of those located in /var/www, **public_html** directories (when enabled) and /usr/share (for web applications). If your site is using a web document root located elsewhere (such as in /srv) you may need to whitelist your document root directory in /etc/apache2/apache2.conf.

The default Ubuntu document root is /var/www/html. You can make your own virtual hosts under /var/www. This is different to previous releases which provides better security out of the box.

# Reporting Problems

Please use the ubuntu-bug tool to report bugs in the Apache2 package with Ubuntu. However, check [existing bug reports](https://bugs.launchpad.net/ubuntu/+source/apache2) before reporting a new bug.

Please report bugs specific to modules (such as PHP and others) to respective packages, not to the web server itself.
</code></pre><p>现在我要做的是修改配置文件，绑定侠客的域名。
为了不影响侠客在迁移过程中的访问，我先不修改xiake.me的解析ip，而先在本地的hosts文件中把xiake.me指向新的服务器的ip地址。</p><pre tabindex=0><code>windows的hosts文件路径
C:\Windows\System32\drivers\etc
</code></pre><p>修改apache的配置文件，绑定xiake.me</p><pre tabindex=0><code>cd /var/www
ls -l
mkdir xiake
ls -l
cd xiake
echo &#34;hello world&#34; &gt; index.html

cd /etc/apache2/sites-available
vim xiake.conf
</code></pre><p>写入如下代码</p><pre tabindex=0><code> ServerName www.xiake.me

 ServerAdmin webmaster@localhost
 DocumentRoot /var/www/xiake

 ErrorLog ${APACHE\_LOG\_DIR}/error.log
 CustomLog ${APACHE\_LOG\_DIR}/access.log combined

 ServerName xiake.me

 ServerAdmin webmaster@localhost
 DocumentRoot /var/www/xiake

 ErrorLog ${APACHE\_LOG\_DIR}/error.log
 CustomLog ${APACHE\_LOG\_DIR}/access.log combined

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
</code></pre><p>更好的方式：</p><pre tabindex=0><code># https://httpd.apache.org/docs/2.4/vhosts/name-based.html
 ServerName www.xiake.me
 ServerAlias xiake.me

 ServerAdmin webmaster@localhost
 DocumentRoot /var/www/xiake

 ErrorLog ${APACHE\_LOG\_DIR}/error.log
 CustomLog ${APACHE\_LOG\_DIR}/access.log combined

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
</code></pre><p>保存后，启用配置</p><pre tabindex=0><code>a2ensite xiake.conf
systemctl reload apache2
</code></pre><p>这时通过浏览器访问xiake.me会看到一句“hello world”。
安装phpMyAdmin</p><pre tabindex=0><code>apt install phpmyadmin
</code></pre><p>创建符号链接</p><pre tabindex=0><code>ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin
</code></pre><p>访问“你的ip/phpmyadmin”测试。这里的用户名和密码是root和你的MySQL密码。
登录phpmyadmin出现错误</p><pre tabindex=0><code>mysqli_real_connect(): (HY000/1698): Access denied for user &#39;root&#39;@&#39;localhost&#39;
</code></pre><p><del>进入 /etc/php/7.2/apache2/php.ini 文件，去掉extension=mysqli前的分号“;”</del>
vim检索：/mysqli，回车，跳到下一个按小写n，上一个是大写N。
按照 <a href=https://askubuntu.com/questions/763336/cannot-enter-phpmyadmin-as-root-mysql-5-7>https://askubuntu.com/questions/763336/cannot-enter-phpmyadmin-as-root-mysql-5-7</a> 的解决方案</p><pre tabindex=0><code>#连接mysql
sudo mysql --user=root mysql

#创建新用户aoyu
CREATE USER &#39;aoyu&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;密码&#39;;
GRANT ALL PRIVILEGES ON *.* TO &#39;aoyu&#39;@&#39;localhost&#39; WITH GRANT OPTION;
FLUSH PRIVILEGES;
</code></pre><p>使用新用户aoyu登录，成功，问题解决。
开启SSL
由于存在风险，我先用另一个域名shuxueben.cn测试。</p><pre tabindex=0><code># 我是完全按照这篇文章来做的。https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-ubuntu-18-04
</code></pre><p>安装ftp server，VSFTP</p><pre tabindex=0><code>apt-get install vsftpd
systemctl start vsftpd
systemctl enable vsftpd

#创建用户，用户名：aoyuftp
useradd -m aoyuftp
#修改/设置密码
passwd aoyuftp #回车后输入密码，两次

#配置文件
cp /etc/vsftpd.conf /etc/vsftpd.conf.bake
&gt; /etc/vsftpd.conf
vim /etc/vsftpd.conf 

#写入如下内容
listen=NO
listen_ipv6=YES
anonymous_enable=NO
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
use_localtime=YES
xferlog_enable=YES
connect_from_port_20=YES
chroot_local_user=YES
secure_chroot_dir=/var/run/vsftpd/empty
pam_service_name=vsftpd
rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
ssl_enable=NO
pasv_enable=Yes
pasv_min_port=10000
pasv_max_port=10100
allow_writeable_chroot=YES

#保存后就可以用ftp客户端登录了，端口22
#我用的是filezilla
</code></pre><p>我在shuxueben.cn安装wordpress时，由于文件权限，需要手动修改wp-config.php。我们需要修改文件的用户和用户组为www-data。apache的用户和用户组可以在/etc/apache2/envvars文件中看到。</p><pre tabindex=0><code>root@iZ2zeajx0vuldrne51da6bZ:/var/www/shuxueben# chown www-data:www-data -R *
</code></pre><p>修改wordpress固定链接，发现.htaccess文件不可写。手动添加后也不能正常访问网页。怀疑apache相关模块未开启。
在phpinfo页面中发现 mod_rewrite 已开启。修改apache配置文件。</p><pre tabindex=0><code># https://www.howtoing.com/how-to-rewrite-urls-with-mod_rewrite-for-apache-on-ubuntu-18-04
#写入

 Options FollowSymLinks
 AllowOverride All
 Require all granted
#加载配置
systemctl reload apache2
</code></pre><p>新服务器上的准备工作差不多已经做完了。在备份原数据前先对博客进行一些优化，避免迁移到新服务器后出现问题。
把主题、插件清理一下；垃圾评论清理一下；回收站文章、草稿清理一下；数据库下载一个插件清理一下。做完之后感觉侠客变快了很多，主要是我把jetpack插件停用了。
备份数据库。</p><pre tabindex=0><code>#使用阿里云的dms管理数据库
sudo /usr/local/mysql/bin/mysql -uroot -p77Bef3a468cc
GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;101.37.74.67&#39; IDENTIFIED BY &#39;77Bef3a468cc&#39; WITH GRANT OPTION;flush privileges; 
</code></pre><p>将备份的数据库文件通过phpmyadmin导入新服务器数据库。
出现错误：</p><pre tabindex=0><code>Warning in ./libraries/plugin_interface.lib.php#551
 count(): Parameter must be an array or an object that implements Countable

Backtrace
</code></pre><p>phpmyadmin版本是4.6.6，与php7.2不兼容。需要升级phpmyadmin。</p><pre tabindex=0><code>#参考http://bilibala.cc/archives/manually-upgrad-phpmyadmin-4-6-to-4-8/

mv /usr/share/phpmyadmin/ /usr/share/phpmyadmin.backup
#通过ftp软件上传从phpmyadmin.net下载的压缩包
unzip phpMyAdmin-4.9.0.1-all-languages.zip
mv phpMyAdmin-4.9.0.1-all-languages phpmyadmin
chown root:root -R phpmyadmin/
mv phpmyadmin /usr/share/
</code></pre><p>从浏览器访问phpmyadmin，已升级，但出现如下问题：</p><pre tabindex=0><code>配置文件现在需要一个短语密码。
变量 $cfg[&#39;TempDir&#39;] （./tmp/）无法访问。phpMyAdmin无法缓存模板文件，所以会运行缓慢。
</code></pre><pre tabindex=0><code>#解决变量 $cfg[&#39;TempDir&#39;] （./tmp/）无法访问。phpMyAdmin无法缓存模板文件，所以会运行缓慢。
#注意先备份
vim /usr/share/phpmyadmin/libraries/vendor_config.php
#修改如下：（可照着升级前的文件改）
define(&#39;CONFIG_DIR&#39;, &#39;/etc/phpmyadmin/&#39;);
#再修改一句：
define(&#39;TEMP_DIR&#39;, &#39;/var/lib/phpmyadmin/tmp/&#39;);

#解决配置文件现在需要一个短语密码。
vim /usr/share/phpmyadmin/libraries/config.default.php
#其中某一句随便写一些字符
$cfg[&#39;blowfish_secret&#39;] = &#39;dajiangdongqulangtaojinqiangufengliurenwu&#39;;

#大功告成，清理文件
rm -f /usr/share/phpmyadmin/libraries/vendor_config.php.backup
rm -rf /usr/share/phpmyadmin.backup
</code></pre><p>我用阿里云的dms导出数据库，导入数据库的时候提示错误。我又用了一个wp插件，用插件备份数据库，虽然有警告但导入成功。
迁移文件。</p><pre tabindex=0><code>mv ./shuxueben/wordpress-5.2.2-zh_CN.tar.gz ./xiake
cd xiake
tar xzf wordpress-5.2.2-zh_CN.tar.gz
rm -f wordpress-5.2.2-zh_CN.tar.gz
chown www-data:www-data -R wordpress
mv wordpress/ mine
</code></pre><p>好吧，太烦了。我直接重装了wordpress，然后导入xml文件。
为侠客开启https</p><pre tabindex=0><code>certbot --apache -d xiake.me -d www.xiake.me
</code></pre><p>SQL查询批量替换图片链接</p><pre tabindex=0><code>UPDATE xk_posts SET post_content = REPLACE( post_content, &#39;https://www.xiake.me/mine/wp-content/uploads&#39;, &#39;https://www.xiake.me/wp-content/uploads&#39; )
</code></pre></div></div><div class=container><nav class="flex container suggested"><a rel=prev href=/post/cotart/wordpress_view_content_after_login/ title="Previous post (older)"><span>Previous</span>
WordPress内容登录后查看
</a><a rel=next href=/post/wp/something-stellio-google-play/ title="Next post (newer)"><span>Next</span>
趣事一则 stellio音乐播放器</a></nav></div><div class=container></div><div class=container><div class=post-comment><div id=vcomments></div><script src=//unpkg.com/valine/dist/Valine.min.js></script><script type=text/javascript>new Valine({el:"#vcomments",appId:"aodxhFvcnQZhByjhPdSxKzWH-gzGzoHsz",appKey:"JbXEtUPYPmhJ285n8cIoAnIn",placeholder:"说点什么吧...",visitor:"true"})</script></div></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=/index.xml>RSS</a></nav></section><script defer src=/ts/features.706a523ba43e6d0427c7fdf2b9d05dbd0920d3f12942b453690b495cb2522743.js data-enable-footnotes=true></script></footer></body></html>